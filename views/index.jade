doctype 5
html(lang="en")
    head
        title=Bacchos
        link(rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css")
    body
        div#map
        div
            form(id="zipcode-form", action="/ajax/map", method="POST")
                input(type='text', name='zipcode')
                input(type='submit', value='search')
        script(type='text/javascript', src='http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js').
        script(type='text/javascript', src='http://code.jquery.com/jquery-1.10.0.min.js').
        script(type='text/javascript').
            $(function(){
                $(document).ready(function() {
                    // mapInit
                    var window_height = $(window).height();
                    var canvas_height = window_height - (window_height/8);
                    $('#map').height(canvas_height);

                    var map = L.map('map').setView([42, -88], 5);
                    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    var popup = L.popup();
                    function onMapClick(e) {
                        popup
                            .setLatLng(e.latlng)
                            .setContent(e.latlng.toString())
                            .openOn(map);
                    }
                    map.on('click', onMapClick);

                    // processZipcodeQuery
                    $('#zipcode-form').submit(function(e) {
                        var postData = $(this).serialize();
                        var formURL = $(this).attr("action");
                        console.log(postData);
                        $.ajax({
                            url: formURL,
                            type: 'post',
                            data: postData,
                            dataType: 'json',

                            // addMarker
                            success: function(data, textStatus, jqXHR) {
                                console.log(textStatus);
                                console.log(jqXHR.status);
                                if (data.length>0) {
                                    for (var i=0; i<data.length; i++) {
                                        var marker = L.marker([data[i].lat, data[i].lng]).addTo(map);
                                        marker.bindPopup("<b>Hello world!</b><br>I am a popup.");
                                    }
                                }
                            },

                            // handleZipcodeError
                            error: function(data, textStatus, jqXHR) {
                                console.log(textStatus);
                                console.log(jqXHR.status);
                            }
                        }); // ajax
                        e.preventDefault(); //STOP default action
                    }); // zipcode submit
                    
                    // resizeMap
                    $(window).resize(function(){
                        var window_height = $(window).height();
                        var canvas_height = window_height - (window_height/8);
                        $('#map').height(canvas_height);
                    }); 
                }); //doc ready
            }); // anonymous func


